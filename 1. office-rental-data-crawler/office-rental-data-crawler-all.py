import requests
import pandas as pd
from concurrent.futures import ThreadPoolExecutor

# API ì •ë³´
API_KEY = "63716794310649c0b1e8bc0666df7902"
BASE_URL = "https://www.reb.or.kr/r-one/openapi/SttsApiTblData.do"

# ë°ì´í„°ë³„ STATBL_ID ì •ì˜ (2002~2024ë…„ ë°ì´í„° í¬í•¨)
data_types = {
    "ì„ëŒ€ë£Œ": {
        "2002-2012": "A_2024_00680", "2013-2016": "A_2024_00257",
        "2017-2018": "A_2024_00261", "2019": "A_2024_00265",
        "2020": "A_2024_00269", "2021": "A_2024_00273",
        "2022-2024Q2": "A_2024_00277", "2024Q3 ì´í›„": "TT249843134237374"
    },
    "ê³µì‹¤ë¥ ": {
        "2002-2012": "A_2024_00678", "2013-2016": "A_2024_00238",
        "2017-2018": "A_2024_00241", "2019": "A_2024_00244",
        "2020": "A_2024_00247", "2021": "A_2024_00250",
        "2022-2024Q2": "A_2024_00253", "2024Q3 ì´í›„": "TT244763134428698"
    },
    "íˆ¬ììˆ˜ìµë¥ ": {
        "2002-2012": "A_2024_00682", "2013-2016": "A_2024_00346",
        "2017-2018": "A_2024_00350", "2019": "A_2024_00354",
        "2020": "A_2024_00358", "2021": "A_2024_00362",
        "2022-2024Q2": "A_2024_00366", "2024Q3 ì´í›„": "T245883135037859"
    },
    "ìˆœì˜ì—…ì†Œë“": {
        "2013-2016": "A_2024_00418", "2017-2018": "A_2024_00422",
        "2019": "A_2024_00426", "2020": "A_2024_00430",
        "2021": "A_2024_00434", "2022-2024Q2": "A_2024_00438",
        "2024Q3 ì´í›„": "TT242303134253883"
    }
}

# ì§€ì—­ ë¶„ë¥˜ ì½”ë“œ ì„¤ì •
region_codes = {
    "2021": {
        "CBD_ê´‘í™”ë¬¸": "520004",
        "CBD_ë‚¨ëŒ€ë¬¸": "520005",
        "CBD_ë™ëŒ€ë¬¸": "520006",
        "CBD_ëª…ë™": "520007",
        "CBD_ì‹œì²­": "520008",
        "CBD_ì„ì§€ë¡œ": "520009",
        "CBD_ì¢…ë¡œ": "520010",
        "CBD_ì¶©ë¬´ë¡œ": "520011",
        "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520013",
        "GBD_êµëŒ€ì—­": "520014",
        "GBD_ë‚¨ë¶€í„°ë¯¸ë„": "520015",
        "GBD_ë…¼í˜„ì—­": "520016",
        "GBD_ë„ì‚°ëŒ€ë¡œ": "520017",
        "GBD_ì‹ ì‚¬ì—­": "520018",
        "GBD_í…Œí—¤ë€ë¡œ": "520019",
        "YBD_ê³µë•ì—­": "520021",
        "YBD_ë‹¹ì‚°ì—­": "520022",
        "YBD_ì—¬ì˜ë„": "520023",
        "YBD_ì˜ë“±í¬ì—­": "520024",
        "Others_ëª©ë™": "520026",
        "Others_ì‚¬ë‹¹": "520027",
        "Others_ìˆ™ëª…ì—¬ëŒ€": "520028",
        "Others_ìš©ì‚°ì—­": "520029",
        "Others_ì ì‹¤ì†¡íŒŒ": "520030",
        "Others_ì ì‹¤ìƒˆë‚´": "520031",
        "Others_ì¥ì•ˆë™": "520032",
        "Others_ì²œí˜¸": "520033",
        "Others_í™ëŒ€í•©ì •": "520034",
        "Others_í™”ê³¡": "520035"
    },
    "2020": {
        "CBD_ê´‘í™”ë¬¸": "520004",
        "CBD_ë‚¨ëŒ€ë¬¸": "520005",
        "CBD_ë™ëŒ€ë¬¸": "520006",
        "CBD_ëª…ë™": "520007",
        "CBD_ì‹œì²­": "520008",
        "CBD_ì„ì§€ë¡œ": "520009",
        "CBD_ì¢…ë¡œ": "520010",
        "CBD_ì¶©ë¬´ë¡œ": "520011",
        "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520013",
        "GBD_ë…¼í˜„ì—­": "520014",
        "GBD_ë„ì‚°ëŒ€ë¡œ": "520015",
        "GBD_ì„œì´ˆ": "520016",
        "GBD_ì‹ ì‚¬ì—­": "520017",
        "GBD_í…Œí—¤ë€ë¡œ": "520018",
        "YBD_ê³µë•ì—­": "520020",
        "YBD_ì—¬ì˜ë„": "520021",
        "YBD_ì˜ë“±í¬": "520022",
        "Others_ëª©ë™": "520024",
        "Others_ì‚¬ë‹¹": "520025",
        "Others_ìš©ì‚°": "520026",
        "Others_ì ì‹¤": "520027",
        "Others_ì¥ì•ˆë™": "520028",
        "Others_ì²œí˜¸": "520029",
        "Others_í™”ê³¡": "520031"
    },
    "2019": {
        "CBD_ê´‘í™”ë¬¸": "520004",
        "CBD_ë™ëŒ€ë¬¸": "520005",
        "CBD_ëª…ë™": "520006",
        "CBD_ë‚¨ëŒ€ë¬¸": "520007",
        "CBD_ì‹œì²­": "520008",
        "CBD_ì„ì§€ë¡œ": "520009",
        "CBD_ì¢…ë¡œ": "520010",
        "CBD_ì¶©ë¬´ë¡œ": "520011",
        "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520013",
        "GBD_ë…¼í˜„ì—­": "520014",
        "GBD_ë„ì‚°ëŒ€ë¡œ": "520015",
        "GBD_ì„œì´ˆ": "520016",
        "GBD_ì‹ ì‚¬ì—­": "520017",
        "GBD_í…Œí—¤ë€ë¡œ": "520018",
        "YBD_ê³µë•ì—­": "520020",
        "YBD_ì—¬ì˜ë„": "520021",
        "YBD_ì˜ë“±í¬": "520022",
        "Others_ëª©ë™": "520024",
        "Others_ì‚¬ë‹¹": "520025",
        "Others_ìš©ì‚°": "520026",
        "Others_ì ì‹¤": "520027",
        "Others_ì¥ì•ˆë™": "520028",
        "Others_ì²œí˜¸": "520029",
        "Others_í™”ê³¡": "520031"
    },
    "2017-2018": {
        "CBD_ê´‘í™”ë¬¸": "520004",
        "CBD_ë™ëŒ€ë¬¸": "520005",
        "CBD_ëª…ë™": "520006",
        "CBD_ì¢…ë¡œ": "520008",
        "CBD_ì¶©ë¬´ë¡œ": "520009",
        "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520011",
        "GBD_ë…¼í˜„ì—­": "520012",
        "GBD_ë„ì‚°ëŒ€ë¡œ": "520013",
        "GBD_ì„œì´ˆ": "520014",
        "GBD_ì‹ ì‚¬ì—­": "520015",
        "GBD_í…Œí—¤ë€ë¡œ": "520016",
        "YBD_ê³µë•ì—­": "520018",
        "YBD_ì—¬ì˜ë„": "520019",
        "YBD_ì˜ë“±í¬": "520020",
        "Others_ëª©ë™": "520022",
        "Others_ì‚¬ë‹¹": "520023",
        "Others_ìš©ì‚°": "520024",
        "Others_ì ì‹¤": "520025",
        "Others_ì¥ì•ˆë™": "520026",
        "Others_ì²œí˜¸": "520027",
        "Others_í™”ê³¡": "520029"
    },
    "2013-2016": {
        "CBD_ê´‘í™”ë¬¸": "520004",
        "CBD_ë™ëŒ€ë¬¸": "520005",
        "CBD_ëª…ë™": "520006",
        "CBD_ì¢…ë¡œ": "520008",
        "CBD_ì¶©ë¬´ë¡œ": "520009",
        "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520011",
        "GBD_ë„ì‚°ëŒ€ë¡œ": "520012",
        "GBD_ì„œì´ˆ": "520013",
        "GBD_í…Œí—¤ë€ë¡œ": "520015",
        "YBD_ê³µë•ì—­": "520017",
        "YBD_ì—¬ì˜ë„": "520018",
        "YBD_ì˜ë“±í¬": "520019",
        "Others_ëª©ë™": "520021",
        "Others_ì‚¬ë‹¹": "520022",
        "Others_ìš©ì‚°": "520023",
        "Others_ì ì‹¤": "520024",
        "Others_ì¥ì•ˆë™": "520025",
        "Others_ì²œí˜¸": "520026",
        "Others_í™”ê³¡": "520028"
    },
    "2002-2012": {
        "CBD_ì‹ ë¬¸ë¡œ": "520004",
        "CBD_ìš°ì •êµ­ë¡œ": "520005",
        "CBD_ë¬´êµ": "520006",
        "CBD_ì²­ê³„": "520007",
        "CBD_ì„œìš¸ì—­": "520008",
        "CBD_ë‚¨ëŒ€ë¬¸": "520009",
        "CBD_ëª…ë™": "520010",
        "CBD_ê¸°íƒ€": "520011",
        "YBD_ë§ˆí¬": "520013",
        "YBD_êµ­íšŒì•": "520014",
        "YBD_ì—¬ì˜ë„ì¤‘ì•™": "520015",
        "YBD_ì¦ê¶Œê±°ë˜ì†Œ": "520016",
        "YBD_ì˜ë“±í¬": "520017",
        "GBD_ë°©ë°°": "520019",
        "GBD_ì„œì´ˆ": "520020",
        "GBD_ë„ì‚°ëŒ€ë¡œ": "520021",
        "GBD_ì—­ì‚¼ë¶ë¶€": "520022",
        "GBD_ì„ ë¦‰ë¶ë¶€": "520023",
        "GBD_ì‚¼ì„±ë¶ë¶€": "520024",
        "GBD_ì—­ì‚¼ë‚¨ë¶€": "520025",
        "GBD_ì„ ë¦‰ë‚¨ë¶€": "520026",
        "GBD_ì‚¼ì„±ë‚¨ë¶€": "520027",
        "GBD_ì–‘ì¬": "520028",
        "GBD_ì†¡íŒŒ": "520029",
        "Others_ì¶©ì •ë¡œ": "520031",
        "Others_ë…¸ì›": "520032",
        "Others_ë™ëŒ€ë¬¸ì„±ë™": "520033",
        "Others_ìš©ì‚°": "520034",
        "Others_ëª©ë™": "520035",
        "Others_êµ¬ë¡œ": "520036",
        "Others_ì‚¬ë‹¹": "520037",
        "Others_ì²œí˜¸": "520038"
    }
}


# ë°ì´í„° ìš”ì²­ í•¨ìˆ˜
def fetch_data_for_region(params, data_type):
    response = requests.get(BASE_URL, params=params)
    print(f"ğŸ” ìš”ì²­ URL: {response.url}")  # ìš”ì²­ URL í™•ì¸

    if response.status_code == 200:
        data = response.json()
        if "RESULT" in data and data["RESULT"]["CODE"] == "INFO-200":
            return None
        elif "SttsApiTblData" in data:
            df = pd.DataFrame(data["SttsApiTblData"][1]["row"])
            df["ì§€í‘œ"] = data_type  # ë°ì´í„° ìœ í˜• ì¶”ê°€
            return df
    return None


# ë°ì´í„° í¬ë¡¤ë§ ì‹¤í–‰ í•¨ìˆ˜
def fetch_office_data(save_csv=True):
    all_data = []
    with ThreadPoolExecutor(max_workers=10) as executor:
        futures = []

        for data_type, statbl_dict in data_types.items():
            for period, statbl_id in statbl_dict.items():
                region_set = region_codes.get(period, region_codes["2002-2012"])  # ì§€ì—­ ì½”ë“œ ë§¤ì¹­

                for region_name, cls_id in region_set.items():
                    params = {
                        "KEY": API_KEY,
                        "Type": "json",
                        "pIndex": 1,
                        "pSize": 100,
                        "STATBL_ID": statbl_id,
                        "DTACYCLE_CD": "QY",
                        "CLS_ID": cls_id,
                        "ITM_ID": "100001"
                    }
                    futures.append(executor.submit(fetch_data_for_region, params, data_type))

        for f in futures:
            result = f.result()
            if result is not None:
                all_data.append(result)

    if all_data:
        final_df = pd.concat(all_data, ignore_index=True)
        final_df = final_df.sort_values(by=["WRTTIME_DESC", "CLS_ID", "ì§€í‘œ"], ascending=[True, True, True])

        if save_csv:
            final_df.to_csv("ì˜¤í”¼ìŠ¤_ì„ëŒ€ë£Œ_ê³µì‹¤ë¥ _íˆ¬ììˆ˜ìµë¥ _ìˆœì˜ì—…ì†Œë“_all.csv", encoding="utf-8-sig", index=False)
            print("âœ… ë°ì´í„° ì €ì¥ ì™„ë£Œ: ì˜¤í”¼ìŠ¤_ì„ëŒ€ë£Œ_ê³µì‹¤ë¥ _íˆ¬ììˆ˜ìµë¥ _ìˆœì˜ì—…ì†Œë“_all.csv")

        print(final_df.head())  # ë°ì´í„° í™•ì¸ìš©
        return final_df

    print("âš ï¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
    return None


# ì‹¤í–‰
fetch_office_data()