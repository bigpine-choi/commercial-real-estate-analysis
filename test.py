import requests
import pandas as pd

# API ì •ë³´
API_KEY = "63716794310649c0b1e8bc0666df7902"
BASE_URL = "https://www.reb.or.kr/r-one/openapi/SttsApiTblData.do"

# ë°ì´í„°ë³„ STATBL_ID (2002~2024ë…„ ë°ì´í„° í¬í•¨)
RENTAL_STATBL_IDS = {
    "2002-2012": "A_2024_00680",  # 2002ë…„~2012ë…„ ë°ì´í„°
    "2013-2016": "A_2024_00257",  # 2013ë…„~2016ë…„ ë°ì´í„°
    "2017-2018": "A_2024_00261",  # 2017ë…„~2018ë…„ ë°ì´í„°
    "2019": "A_2024_00265",  # 2019ë…„ ë°ì´í„°
    "2020": "A_2024_00269",  # 2020ë…„ ë°ì´í„°
    "2021": "A_2024_00273",  # 2021ë…„ ë°ì´í„°
    "2022-2024Q2": "A_2024_00277",  # 2022ë…„~2024ë…„ 2ë¶„ê¸° ë°ì´í„°
    "2024Q3 ì´í›„": "TT249843134237374"  # 2024ë…„ 3ë¶„ê¸° ì´í›„ ë°ì´í„°
}

VACANCY_STATBL_IDS = {
    "2002-2012": "A_2024_00678",  # 2002ë…„~2012ë…„ ë°ì´í„°
    "2013-2016": "A_2024_00238",  # 2013ë…„~2016ë…„ ë°ì´í„°
    "2017-2018": "A_2024_00241",  # 2017ë…„~2018ë…„ ë°ì´í„°
    "2019": "A_2024_00244",  # 2019ë…„ ë°ì´í„°
    "2020": "A_2024_00247",  # 2020ë…„ ë°ì´í„°
    "2021": "A_2024_00250",  # 2021ë…„ ë°ì´í„°
    "2022-2024Q2": "A_2024_00253",  # 2022ë…„~2024ë…„ 2ë¶„ê¸° ë°ì´í„°
    "2024Q3 ì´í›„": "TT244763134428698"  # 2024ë…„ 3ë¶„ê¸° ì´í›„ ë°ì´í„°
}

# 2021ë…„ ì´í›„ ì „êµ­ + ê° ì§€ì—­ ë¶„ë¥˜ ì½”ë“œ (ì„œìš¸ ì£¼ìš” ê¶Œì—­ í¬í•¨)
region_codes_new = {
    "ì„œìš¸ì „ì²´": "500002",
    "CBD": "510003",
    "GBD": "510004",
    "YBD": "510005",
    "Others": "510006",
    "CBD_ê´‘í™”ë¬¸": "520004",
    "CBD_ë‚¨ëŒ€ë¬¸": "520005",
    "CBD_ë™ëŒ€ë¬¸": "520006",
    "CBD_ëª…ë™": "520007",
    "CBD_ì‹œì²­": "520008",
    "CBD_ì„ì§€ë¡œ": "520009",
    "CBD_ì¢…ë¡œ": "520010",
    "CBD_ì¶©ë¬´ë¡œ": "520011",
    "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520013",
    "GBD_êµëŒ€ì—­": "520014",
    "GBD_ë‚¨ë¶€í„°ë¯¸ë„": "520015",
    "GBD_ë…¼í˜„ì—­": "520016",
    "GBD_ë„ì‚°ëŒ€ë¡œ": "520017",
    "GBD_ì‹ ì‚¬ì—­": "520018",
    "GBD_í…Œí—¤ë€ë¡œ": "520019",
    "YBD_ê³µë•ì—­": "520021",
    "YBD_ë‹¹ì‚°ì—­": "520022",
    "YBD_ì—¬ì˜ë„": "520023",
    "YBD_ì˜ë“±í¬ì—­": "520024",
    "Others_ëª©ë™": "520026",
    "Others_ì‚¬ë‹¹": "520027",
    "Others_ìˆ™ëª…ì—¬ëŒ€": "520028",
    "Others_ìš©ì‚°ì—­": "520029",
    "Others_ì ì‹¤ì†¡íŒŒ": "520030",
    "Others_ì ì‹¤ìƒˆë‚´": "520031",
    "Others_ì¥ì•ˆë™": "520032",
    "Others_ì²œí˜¸": "520033",
    "Others_í™ëŒ€í•©ì •": "520034",
    "Others_í™”ê³¡": "520035"
}

# 2020ë…„ ì„œìš¸ ì£¼ìš” ê¶Œì—­ ë¶„ë¥˜ ì½”ë“œ
region_codes_2020 = {
    "ì„œìš¸ì „ì²´": "500002",
    "CBD": "510003",
    "GBD": "510004",
    "YBD": "510005",
    "Others": "510006",
    "CBD_ê´‘í™”ë¬¸": "520004",
    "CBD_ë‚¨ëŒ€ë¬¸": "520005",
    "CBD_ë™ëŒ€ë¬¸": "520006",
    "CBD_ëª…ë™": "520007",
    "CBD_ì‹œì²­": "520008",
    "CBD_ì„ì§€ë¡œ": "520009",
    "CBD_ì¢…ë¡œ": "520010",
    "CBD_ì¶©ë¬´ë¡œ": "520011",
    "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520013",
    "GBD_ë…¼í˜„ì—­": "520014",
    "GBD_ë„ì‚°ëŒ€ë¡œ": "520015",
    "GBD_ì„œì´ˆ": "520016",
    "GBD_ì‹ ì‚¬ì—­": "520017",
    "GBD_í…Œí—¤ë€ë¡œ": "520018",
    "YBD_ê³µë•ì—­": "520020",
    "YBD_ì—¬ì˜ë„": "520021",
    "YBD_ì˜ë“±í¬": "520022",
    "Others_ëª©ë™": "520024",
    "Others_ì‚¬ë‹¹": "520025",
    "Others_ìš©ì‚°": "520026",
    "Others_ì ì‹¤": "520027",
    "Others_ì¥ì•ˆë™": "520028",
    "Others_ì²œí˜¸": "520029",
    "Others_í™”ê³¡": "520031"
}

# 2019ë…„ ì„œìš¸ ì£¼ìš” ê¶Œì—­ ë¶„ë¥˜ ì½”ë“œ
region_codes_2019 = {
    "ì„œìš¸ì „ì²´": "500002",
    "CBD": "510003",
    "GBD": "510004",
    "YBD": "510005",
    "Others": "510006",
    "CBD_ê´‘í™”ë¬¸": "520004",
    "CBD_ë™ëŒ€ë¬¸": "520005",
    "CBD_ëª…ë™": "520006",
    "CBD_ë‚¨ëŒ€ë¬¸": "520007",
    "CBD_ì‹œì²­": "520008",
    "CBD_ì„ì§€ë¡œ": "520009",
    "CBD_ì¢…ë¡œ": "520010",
    "CBD_ì¶©ë¬´ë¡œ": "520011",
    "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520013",
    "GBD_ë…¼í˜„ì—­": "520014",
    "GBD_ë„ì‚°ëŒ€ë¡œ": "520015",
    "GBD_ì„œì´ˆ": "520016",
    "GBD_ì‹ ì‚¬ì—­": "520017",
    "GBD_í…Œí—¤ë€ë¡œ": "520018",
    "YBD_ê³µë•ì—­": "520020",
    "YBD_ì—¬ì˜ë„": "520021",
    "YBD_ì˜ë“±í¬": "520022",
    "Others_ëª©ë™": "520024",
    "Others_ì‚¬ë‹¹": "520025",
    "Others_ìš©ì‚°": "520026",
    "Others_ì ì‹¤": "520027",
    "Others_ì¥ì•ˆë™": "520028",
    "Others_ì²œí˜¸": "520029",
    "Others_í™”ê³¡": "520031"
}

# 2017~2018ë…„ ì„œìš¸ ì£¼ìš” ê¶Œì—­ ë¶„ë¥˜ ì½”ë“œ
region_codes_20172018 = {
    "ì„œìš¸ì „ì²´": "500002",
    "CBD": "510003",
    "GBD": "510004",
    "YBD": "510005",
    "Others": "510006",
    "CBD_ê´‘í™”ë¬¸": "520004",
    "CBD_ë™ëŒ€ë¬¸": "520005",
    "CBD_ëª…ë™": "520006",
    "CBD_ì¢…ë¡œ": "520008",
    "CBD_ì¶©ë¬´ë¡œ": "520009",
    "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520011",
    "GBD_ë…¼í˜„ì—­": "520012",
    "GBD_ë„ì‚°ëŒ€ë¡œ": "520013",
    "GBD_ì„œì´ˆ": "520014",
    "GBD_ì‹ ì‚¬ì—­": "520015",
    "GBD_í…Œí—¤ë€ë¡œ": "520016",
    "YBD_ê³µë•ì—­": "520018",
    "YBD_ì—¬ì˜ë„": "520019",
    "YBD_ì˜ë“±í¬": "520020",
    "Others_ëª©ë™": "520022",
    "Others_ì‚¬ë‹¹": "520023",
    "Others_ìš©ì‚°": "520024",
    "Others_ì ì‹¤": "520025",
    "Others_ì¥ì•ˆë™": "520026",
    "Others_ì²œí˜¸": "520027",
    "Others_í™”ê³¡": "520029"
}

# 2013~2016ë…„ ì„œìš¸ ì£¼ìš” ê¶Œì—­ ë¶„ë¥˜ ì½”ë“œ
region_codes_20132016 = {
    "ì„œìš¸ì „ì²´": "500002",
    "CBD": "510003",
    "GBD": "510004",
    "YBD": "510005",
    "Others": "510006",
    "CBD_ê´‘í™”ë¬¸": "520004",
    "CBD_ë™ëŒ€ë¬¸": "520005",
    "CBD_ëª…ë™": "520006",
    "CBD_ì¢…ë¡œ": "520008",
    "CBD_ì¶©ë¬´ë¡œ": "520009",
    "GBD_ê°•ë‚¨ëŒ€ë¡œ": "520011",
    "GBD_ë„ì‚°ëŒ€ë¡œ": "520012",
    "GBD_ì„œì´ˆ": "520013",
    "GBD_í…Œí—¤ë€ë¡œ": "520015",
    "YBD_ê³µë•ì—­": "520017",
    "YBD_ì—¬ì˜ë„": "520018",
    "YBD_ì˜ë“±í¬": "520019",
    "Others_ëª©ë™": "520021",
    "Others_ì‚¬ë‹¹": "520022",
    "Others_ìš©ì‚°": "520023",
    "Others_ì ì‹¤": "520024",
    "Others_ì¥ì•ˆë™": "520025",
    "Others_ì²œí˜¸": "520026",
    "Others_í™”ê³¡": "520028"
}

# 2002~2012ë…„ ì„œìš¸ ì£¼ìš” ê¶Œì—­ ë¶„ë¥˜ ì½”ë“œ
region_codes_20022012 = {
    "ì„œìš¸ì „ì²´": "500002",
    "CBD": "510003",
    "YBD": "510004",
    "GBD": "510005",
    "Others": "510006",
    "CBD_ì‹ ë¬¸ë¡œ": "520004",
    "CBD_ìš°ì •êµ­ë¡œ": "520005",
    "CBD_ë¬´êµ": "520006",
    "CBD_ì²­ê³„": "520007",
    "CBD_ì„œìš¸ì—­": "520008",
    "CBD_ë‚¨ëŒ€ë¬¸": "520009",
    "CBD_ëª…ë™": "520010",
    "CBD_ê¸°íƒ€": "520011",
    "YBD_ë§ˆí¬": "520013",
    "YBD_êµ­íšŒì•": "520014",
    "YBD_ì—¬ì˜ë„ì¤‘ì•™": "520015",
    "YBD_ì¦ê¶Œê±°ë˜ì†Œ": "520016",
    "YBD_ì˜ë“±í¬": "520017",
    "GBD_ë°©ë°°": "520019",
    "GBD_ì„œì´ˆ": "520020",
    "GBD_ë„ì‚°ëŒ€ë¡œ": "520021",
    "GBD_ì—­ì‚¼ë¶ë¶€": "520022",
    "GBD_ì„ ë¦‰ë¶ë¶€": "520023",
    "GBD_ì‚¼ì„±ë¶ë¶€": "520024",
    "GBD_ì—­ì‚¼ë‚¨ë¶€": "520025",
    "GBD_ì„ ë¦‰ë‚¨ë¶€": "520026",
    "GBD_ì‚¼ì„±ë‚¨ë¶€": "520027",
    "GBD_ì–‘ì¬": "520028",
    "GBD_ì†¡íŒŒ": "520029",
    "Others_ì¶©ì •ë¡œ": "520031",
    "Others_ë…¸ì›": "520032",
    "Others_ë™ëŒ€ë¬¸ì„±ë™": "520033",
    "Others_ìš©ì‚°": "520034",
    "Others_ëª©ë™": "520035",
    "Others_êµ¬ë¡œ": "520036",
    "Others_ì‚¬ë‹¹": "520037",
    "Others_ì²œí˜¸": "520038"
}

# ê²°ê³¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
all_data = []

for period, rental_statbl_id in RENTAL_STATBL_IDS.items():
    vacancy_statbl_id = VACANCY_STATBL_IDS[period]  # ê°™ì€ ê¸°ê°„ì˜ ê³µì‹¤ë¥  ID ì‚¬ìš©

    # ğŸ“Œ **2021ë…„ ì´í›„ ì§€ì—­ ë¶„ë¥˜ì½”ë“œ ì‚¬ìš©**
    if period in ["2021", "2022-2024Q2", "2024Q3 ì´í›„"]:
        region_codes = region_codes_new
    elif period == "2020":
        region_codes = region_codes_2020
    elif period == "2019":
        region_codes = region_codes_2019
    elif period == "2017-2018":
        region_codes = region_codes_20172018
    elif period == "2013-2016":
        region_codes = region_codes_20132016
    else:
        region_codes = region_codes_20022012

    for region_name, cls_id in region_codes.items():
        # ğŸ”¹ ì„ëŒ€ë£Œ ë°ì´í„° ìš”ì²­
        params_rental = {
            "KEY": API_KEY,
            "Type": "json",
            "pIndex": 1,
            "pSize": 100,
            "STATBL_ID": rental_statbl_id,  # ì„ëŒ€ë£Œ ë°ì´í„° ì½”ë“œ
            "DTACYCLE_CD": "QY",  # ë¶„ê¸°ë³„ ë°ì´í„°
            "CLS_ID": cls_id,  # ì§€ì—­ ì½”ë“œ
            "ITM_ID": "100001"  # ì„ëŒ€ë£Œ ITM_ID
        }

        response_rental = requests.get(BASE_URL, params=params_rental)

        if response_rental.status_code == 200:
            data_rental = response_rental.json()
            if "SttsApiTblData" in data_rental:
                rental_data = data_rental["SttsApiTblData"][1]["row"]
                df_rental = pd.DataFrame(rental_data)
                df_rental["ì§€ì—­"] = region_name
                df_rental["ì§€í‘œ"] = "ì„ëŒ€ë£Œ"
                all_data.append(df_rental)
            else:
                print(f"âŒ {region_name} ì„ëŒ€ë£Œ ë°ì´í„° ì—†ìŒ ({period}):", data_rental)
        else:
            print(f"ğŸš¨ API ìš”ì²­ ì‹¤íŒ¨ ({region_name} - ì„ëŒ€ë£Œ {period}):", response_rental.status_code, response_rental.text)

        # ğŸ”¹ ê³µì‹¤ë¥  ë°ì´í„° ìš”ì²­
        params_vacancy = {
            "KEY": API_KEY,
            "Type": "json",
            "pIndex": 1,
            "pSize": 100,
            "STATBL_ID": vacancy_statbl_id,  # ê³µì‹¤ë¥  ë°ì´í„° ì½”ë“œ
            "DTACYCLE_CD": "QY",  # ë¶„ê¸°ë³„ ë°ì´í„°
            "CLS_ID": cls_id,  # ì§€ì—­ ì½”ë“œ
            "ITM_ID": "100001"  # ê³µì‹¤ë¥  ITM_ID
        }

        response_vacancy = requests.get(BASE_URL, params=params_vacancy)

        if response_vacancy.status_code == 200:
            data_vacancy = response_vacancy.json()
            if "SttsApiTblData" in data_vacancy:
                vacancy_data = data_vacancy["SttsApiTblData"][1]["row"]
                df_vacancy = pd.DataFrame(vacancy_data)
                df_vacancy["ì§€ì—­"] = region_name
                df_vacancy["ì§€í‘œ"] = "ê³µì‹¤ë¥ "
                all_data.append(df_vacancy)
            else:
                print(f"âŒ {region_name} ê³µì‹¤ë¥  ë°ì´í„° ì—†ìŒ ({period}):", data_vacancy)
        else:
            print(f"ğŸš¨ API ìš”ì²­ ì‹¤íŒ¨ ({region_name} - ê³µì‹¤ë¥  {period}):", response_vacancy.status_code, response_vacancy.text)

# ğŸ”¹ ëª¨ë“  ë°ì´í„° í•©ì¹˜ê¸°
if all_data:
    final_df = pd.concat(all_data, ignore_index=True)

    # ğŸ”¹ ì‹œê°„ìˆœ ì •ë ¬ + CLS_ID ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
    final_df = final_df.sort_values(by=["WRTTIME_DESC","CLS_ID"], ascending=[True,True])

    # CSVë¡œ ì €ì¥
    final_df.to_csv("ì˜¤í”¼ìŠ¤_ì„ëŒ€ë£Œ_ê³µì‹¤ë¥ _ì„œìš¸_ì‹œê°„ìˆœ.csv", encoding="utf-8-sig", index=False)
    print("âœ… ëª¨ë“  ì§€ì—­ ì„ëŒ€ë£Œ + ê³µì‹¤ë¥  ë°ì´í„° ì €ì¥ ì™„ë£Œ: ì˜¤í”¼ìŠ¤_ì„ëŒ€ë£Œ_ê³µì‹¤ë¥ _ì„œìš¸_ì‹œê°„ìˆœ.csv")
else:
    print("âš ï¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")